# RAG知识问答系统 - 后端部署和启动指南

> **文档版本**: v1.0  
> **更新日期**: 2025-10-17  
> **适用环境**: 开发/生产

---

## 📋 目录

1. [环境准备](#1-环境准备)
2. [开发环境启动](#2-开发环境启动)
3. [生产环境部署](#3-生产环境部署)
4. [数据库初始化流程](#4-数据库初始化流程)
5. [常见问题排查](#5-常见问题排查)
6. [启动脚本](#6-启动脚本)

---

## 1. 环境准备

### 1.1 系统要求

**硬件要求**:
- CPU: 2核心以上
- 内存: 4GB以上（推荐8GB）
- 磁盘: 10GB可用空间
- 网络: 稳定的网络连接

**软件要求**:
- 操作系统: Linux/macOS/Windows
- Python: 3.8+
- MySQL: 5.7+ 或 MariaDB 10.2+
- Git: 用于代码管理

### 1.2 安装Python环境

**Linux/macOS**:

```bash
# 检查Python版本
python3 --version

# 安装pip
sudo apt-get install python3-pip  # Ubuntu/Debian
sudo yum install python3-pip      # CentOS/RHEL

# 安装虚拟环境工具
pip3 install virtualenv
```

**Windows**:

1. 下载Python安装包：https://www.python.org/downloads/
2. 安装时勾选"Add Python to PATH"
3. 打开命令提示符验证：`python --version`

### 1.3 安装MySQL

**Linux**:

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# 启动MySQL
sudo systemctl start mysql
sudo systemctl enable mysql
```

**Windows**:

1. 下载MySQL安装包：https://dev.mysql.com/downloads/installer/
2. 运行安装向导
3. 设置root密码
4. 启动MySQL服务

**macOS**:

```bash
# 使用Homebrew
brew install mysql
brew services start mysql
```

---

## 2. 开发环境启动

### 2.1 克隆项目

```bash
# 克隆仓库
git clone <repository-url>
cd ZhongMeiRagProject/backEnd
```

### 2.2 创建虚拟环境

**Linux/macOS**:

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate
```

**Windows**:

```powershell
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate
```

### 2.3 安装依赖

```bash
# 确保虚拟环境已激活
pip install -r requirements.txt
```

### 2.4 配置环境变量

```bash
# 复制环境变量示例文件
cp env.example .env

# 编辑.env文件
vi .env  # 或使用其他编辑器
```

**必须配置的项**:

```ini
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=rag_knowledge_base

# JWT密钥（生产环境必须修改！）
JWT_SECRET_KEY=your-secret-key-change-in-production
```

### 2.5 初始化数据库

**方法一：使用Python脚本（推荐）**

```bash
python scripts/init_db.py
```

按提示输入 `yes` 确认初始化。

**方法二：使用SQL脚本**

```bash
# 创建数据库
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS rag_knowledge_base CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 导入表结构和初始数据
mysql -u root -p rag_knowledge_base < scripts/create_db.sql
```

### 2.6 启动开发服务器

```bash
# 方法1: 直接运行
python app.py

# 方法2: 使用Flask命令
export FLASK_APP=app.py
export FLASK_ENV=development
flask run --host=0.0.0.0 --port=8000

# Windows PowerShell
$env:FLASK_APP="app.py"
$env:FLASK_ENV="development"
flask run --host=0.0.0.0 --port=8000
```

### 2.7 验证启动

打开浏览器访问：

- **健康检查**: http://localhost:8000/health
- **API测试**: 使用Postman导入接口文档

```bash
# 命令行测试
curl http://localhost:8000/health
```

预期响应：

```json
{
  "status": "healthy",
  "service": "RAG Knowledge Base API",
  "version": "1.0.0"
}
```

---

## 3. 生产环境部署

### 3.1 服务器准备

**1. 更新系统**

```bash
sudo apt-get update
sudo apt-get upgrade -y
```

**2. 安装必要软件**

```bash
sudo apt-get install -y python3 python3-pip mysql-server nginx supervisor
```

**3. 创建部署用户**

```bash
sudo useradd -m -s /bin/bash ragapp
sudo usermod -aG sudo ragapp
```

### 3.2 部署代码

```bash
# 切换到部署用户
su - ragapp

# 克隆代码
git clone <repository-url> /home/ragapp/rag-backend
cd /home/ragapp/rag-backend/backEnd

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
pip install gunicorn
```

### 3.3 配置生产环境变量

```bash
# 创建.env文件
vi .env
```

```ini
# 生产环境配置
FLASK_ENV=production
FLASK_DEBUG=False

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=rag_user
DB_PASSWORD=strong_password_here
DB_NAME=rag_knowledge_base

# JWT密钥（必须修改！）
JWT_SECRET_KEY=use-a-strong-random-key-here

# 日志配置
LOG_LEVEL=WARNING
LOG_FILE=/home/ragapp/logs/app.log

# CORS配置
CORS_ORIGINS=https://yourdomain.com
```

### 3.4 初始化生产数据库

```bash
# 创建MySQL用户和数据库
mysql -u root -p << EOF
CREATE DATABASE IF NOT EXISTS rag_knowledge_base CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'rag_user'@'localhost' IDENTIFIED BY 'strong_password_here';
GRANT ALL PRIVILEGES ON rag_knowledge_base.* TO 'rag_user'@'localhost';
FLUSH PRIVILEGES;
EOF

# 初始化数据
python scripts/init_db.py
```

### 3.5 配置Gunicorn

创建 `gunicorn_config.py`:

```python
"""Gunicorn配置文件"""
import os

# 绑定地址
bind = "127.0.0.1:8000"

# 工作进程数
workers = 4

# 工作线程数
threads = 2

# 超时时间
timeout = 120

# 访问日志
accesslog = "/home/ragapp/logs/gunicorn_access.log"
errorlog = "/home/ragapp/logs/gunicorn_error.log"
loglevel = "info"

# 进程名称
proc_name = "rag-backend"

# Daemon模式
daemon = False
```

### 3.6 配置Supervisor

创建 `/etc/supervisor/conf.d/rag-backend.conf`:

```ini
[program:rag-backend]
command=/home/ragapp/rag-backend/backEnd/venv/bin/gunicorn -c gunicorn_config.py app:app
directory=/home/ragapp/rag-backend/backEnd
user=ragapp
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/home/ragapp/logs/supervisor.log
environment=PATH="/home/ragapp/rag-backend/backEnd/venv/bin"
```

**启动Supervisor**:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start rag-backend
sudo supervisorctl status
```

### 3.7 配置Nginx

创建 `/etc/nginx/sites-available/rag-backend`:

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;
    
    # 日志
    access_log /var/log/nginx/rag-backend-access.log;
    error_log /var/log/nginx/rag-backend-error.log;
    
    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
    }
    
    # 文件上传大小限制
    client_max_body_size 100M;
}
```

**启用站点**:

```bash
sudo ln -s /etc/nginx/sites-available/rag-backend /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 3.8 配置SSL证书（可选但推荐）

```bash
# 使用Let's Encrypt
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d api.yourdomain.com
```

### 3.9 配置防火墙

```bash
# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

---

## 4. 数据库初始化流程

### 4.1 完整流程图

```
开始
  ↓
检查MySQL连接
  ↓
创建数据库（如果不存在）
  ↓
创建数据表
  ├─ users（用户表）
  ├─ knowledge_bases（知识库表）
  ├─ documents（文档表）
  ├─ knowledge_base_permissions（权限表）
  ├─ chat_sessions（会话表）
  ├─ chat_messages（消息表）
  ├─ models（模型表）
  └─ login_records（登录记录表）
  ↓
插入初始数据
  ├─ 管理员账号（admin/admin123）
  ├─ 测试用户（user/user123）
  ├─ 默认LLM模型
  ├─ 默认Embedding模型
  └─ 示例知识库
  ↓
验证数据完整性
  ↓
完成
```

### 4.2 手动初始化步骤

如果自动脚本失败，可以手动执行：

```bash
# 1. 连接MySQL
mysql -u root -p

# 2. 创建数据库
CREATE DATABASE IF NOT EXISTS rag_knowledge_base CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE rag_knowledge_base;

# 3. 执行建表脚本
SOURCE /path/to/scripts/create_db.sql;

# 4. 验证表结构
SHOW TABLES;
DESC users;

# 5. 检查初始数据
SELECT * FROM users;
SELECT * FROM models;

# 6. 退出
EXIT;
```

### 4.3 数据库备份与恢复

**备份**:

```bash
# 备份数据库
mysqldump -u root -p rag_knowledge_base > backup_$(date +%Y%m%d_%H%M%S).sql

# 备份向量数据
tar -czf chroma_backup_$(date +%Y%m%d).tar.gz chroma_db/
```

**恢复**:

```bash
# 恢复MySQL数据
mysql -u root -p rag_knowledge_base < backup_20251017_120000.sql

# 恢复向量数据
tar -xzf chroma_backup_20251017.tar.gz
```

---

## 5. 常见问题排查

### 5.1 数据库连接失败

**错误信息**: `Can't connect to MySQL server`

**解决方案**:

```bash
# 1. 检查MySQL服务
sudo systemctl status mysql

# 2. 启动MySQL
sudo systemctl start mysql

# 3. 检查端口监听
sudo netstat -tlnp | grep 3306

# 4. 检查防火墙
sudo ufw status

# 5. 测试连接
mysql -u root -p -h localhost
```

### 5.2 依赖安装失败

**错误信息**: `Failed building wheel for ...`

**解决方案**:

```bash
# 更新pip
pip install --upgrade pip setuptools wheel

# 安装编译工具（Linux）
sudo apt-get install python3-dev build-essential

# 重新安装依赖
pip install -r requirements.txt
```

### 5.3 端口被占用

**错误信息**: `Address already in use`

**解决方案**:

```bash
# 查找占用端口的进程
lsof -i :8000  # Linux/macOS
netstat -ano | findstr :8000  # Windows

# 终止进程
kill -9 <PID>  # Linux/macOS
taskkill /PID <PID> /F  # Windows

# 或更换端口
flask run --port=8001
```

### 5.4 权限问题

**错误信息**: `Permission denied`

**解决方案**:

```bash
# 修改目录权限
sudo chown -R ragapp:ragapp /home/ragapp/rag-backend
sudo chmod -R 755 /home/ragapp/rag-backend

# 创建日志目录
mkdir -p /home/ragapp/logs
chmod 755 /home/ragapp/logs
```

### 5.5 日志查看

```bash
# 应用日志
tail -f logs/app.log

# Gunicorn日志
tail -f /home/ragapp/logs/gunicorn_error.log

# Supervisor日志
tail -f /home/ragapp/logs/supervisor.log

# Nginx日志
sudo tail -f /var/log/nginx/rag-backend-error.log
```

---

## 6. 启动脚本

### 6.1 开发环境启动脚本

创建 `start_dev.sh`:

```bash
#!/bin/bash

echo "===================================="
echo " RAG知识问答系统 - 开发环境启动"
echo "===================================="

# 检查虚拟环境
if [ ! -d "venv" ]; then
    echo "错误: 虚拟环境不存在，请先运行 python3 -m venv venv"
    exit 1
fi

# 激活虚拟环境
source venv/bin/activate

# 检查.env文件
if [ ! -f ".env" ]; then
    echo "警告: .env文件不存在，从env.example复制..."
    cp env.example .env
    echo "请编辑.env文件配置数据库连接"
    exit 1
fi

# 设置环境变量
export FLASK_APP=app.py
export FLASK_ENV=development

# 启动服务
echo "正在启动开发服务器..."
echo "访问地址: http://localhost:8000"
echo "健康检查: http://localhost:8000/health"
echo "按 Ctrl+C 停止服务"
echo ""

python app.py
```

```bash
# 添加执行权限
chmod +x start_dev.sh

# 启动
./start_dev.sh
```

### 6.2 生产环境启动脚本

创建 `start_prod.sh`:

```bash
#!/bin/bash

echo "===================================="
echo " RAG知识问答系统 - 生产环境启动"
echo "===================================="

# 检查用户
if [ "$USER" != "ragapp" ]; then
    echo "警告: 建议使用ragapp用户运行"
fi

# 激活虚拟环境
source /home/ragapp/rag-backend/backEnd/venv/bin/activate

# 检查配置
if [ ! -f ".env" ]; then
    echo "错误: .env文件不存在"
    exit 1
fi

# 启动Supervisor
sudo supervisorctl start rag-backend
sleep 2

# 检查状态
STATUS=$(sudo supervisorctl status rag-backend | awk '{print $2}')

if [ "$STATUS" == "RUNNING" ]; then
    echo "✅ 服务启动成功"
    echo "访问地址: http://your-server-ip:8000"
    sudo supervisorctl status rag-backend
else
    echo "❌ 服务启动失败"
    echo "查看日志: tail -f /home/ragapp/logs/supervisor.log"
    exit 1
fi
```

### 6.3 停止脚本

创建 `stop.sh`:

```bash
#!/bin/bash

echo "停止RAG后端服务..."

# 开发环境：查找并终止Python进程
pkill -f "python app.py"

# 生产环境：停止Supervisor管理的服务
if command -v supervisorctl &> /dev/null; then
    sudo supervisorctl stop rag-backend
fi

echo "服务已停止"
```

### 6.4 重启脚本

创建 `restart.sh`:

```bash
#!/bin/bash

echo "重启RAG后端服务..."

# 生产环境
if command -v supervisorctl &> /dev/null; then
    sudo supervisorctl restart rag-backend
    sleep 2
    sudo supervisorctl status rag-backend
else
    # 开发环境
    ./stop.sh
    sleep 1
    ./start_dev.sh
fi
```

### 6.5 健康检查脚本

创建 `health_check.sh`:

```bash
#!/bin/bash

echo "执行健康检查..."

# 检查API响应
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)

if [ "$RESPONSE" -eq 200 ]; then
    echo "✅ 服务正常运行"
    curl -s http://localhost:8000/health | python3 -m json.tool
    exit 0
else
    echo "❌ 服务异常 (HTTP $RESPONSE)"
    exit 1
fi
```

---

## 7. 监控和维护

### 7.1 日志轮转

创建 `/etc/logrotate.d/rag-backend`:

```
/home/ragapp/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 ragapp ragapp
    sharedscripts
    postrotate
        sudo supervisorctl restart rag-backend
    endscript
}
```

### 7.2 定时任务

编辑crontab：

```bash
crontab -e
```

添加：

```cron
# 每天凌晨2点备份数据库
0 2 * * * /home/ragapp/scripts/backup.sh

# 每小时检查服务状态
0 * * * * /home/ragapp/rag-backend/backEnd/health_check.sh

# 每周日凌晨3点清理旧日志
0 3 * * 0 find /home/ragapp/logs -name "*.log.*" -mtime +30 -delete
```

### 7.3 性能监控

```bash
# 查看进程资源占用
ps aux | grep gunicorn

# 查看内存使用
free -h

# 查看磁盘使用
df -h

# 实时监控
htop
```

---

## 8. 更新部署

```bash
# 1. 备份数据
./scripts/backup.sh

# 2. 拉取最新代码
git pull origin main

# 3. 更新依赖
source venv/bin/activate
pip install -r requirements.txt

# 4. 应用数据库迁移（如有）
flask db upgrade

# 5. 重启服务
sudo supervisorctl restart rag-backend

# 6. 验证
./health_check.sh
```

---

## 9. 回滚操作

如果更新后出现问题：

```bash
# 1. 切换到上一个版本
git checkout <previous-commit-hash>

# 2. 恢复数据库
mysql -u root -p rag_knowledge_base < backup_latest.sql

# 3. 重启服务
sudo supervisorctl restart rag-backend
```

---

## 📞 技术支持

遇到问题请查看：
- 应用日志: `logs/app.log`
- 错误日志: `/home/ragapp/logs/gunicorn_error.log`
- 系统日志: `/var/log/syslog`

**联系方式**: support@example.com

---

**祝部署顺利！** 🚀

