<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能问答 - RAG知识问答系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .message-animation {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            display: inline-block;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9CA3AF;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #D1D5DB;
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 侧边栏 -->
    <div class="fixed left-0 top-0 h-full w-80 bg-white shadow-lg border-r border-gray-200 z-20">
        <!-- 顶部导航 -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <div class="flex items-center">
                <a href="#" onclick="goBack()" class="text-gray-600 hover:text-gray-900 mr-3">
                    <i class="fas fa-arrow-left text-lg"></i>
                </a>
                <div>
                    <h1 class="text-lg font-bold text-gray-900">智能问答</h1>
                    <p class="text-xs text-gray-500">AI驱动的智能检索</p>
                </div>
            </div>
            <button onclick="newChat()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition-colors duration-200">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- 知识库选择 -->
        <div class="p-4 border-b border-gray-200">
            <label class="block text-sm font-medium text-gray-700 mb-2">选择知识库</label>
            <select id="knowledgeBase" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="all">全部知识库</option>
                <option value="tech">技术规范库</option>
                <option value="product">产品手册</option>
                <option value="ops">运维文档</option>
            </select>
        </div>

        <!-- 模型选择 -->
        <div class="p-4 border-b border-gray-200">
            <label class="block text-sm font-medium text-gray-700 mb-2">选择模型</label>
            <select id="modelSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="qwen2">Qwen2-7B</option>
                <option value="llama3">Llama3-8B</option>
                <option value="chatglm">ChatGLM3-6B</option>
            </select>
        </div>

        <!-- 会话历史 -->
        <div class="flex-1 p-4">
            <h3 class="text-sm font-medium text-gray-700 mb-3">会话历史</h3>
            <div class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin">
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors duration-200">
                    <p class="text-sm font-medium text-gray-900 truncate">API设计最佳实践</p>
                    <p class="text-xs text-gray-500 mt-1">今天 14:30</p>
                </div>
                <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200">
                    <p class="text-sm font-medium text-gray-900 truncate">数据库连接池配置</p>
                    <p class="text-xs text-gray-500 mt-1">今天 10:15</p>
                </div>
                <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200">
                    <p class="text-sm font-medium text-gray-900 truncate">Redis缓存策略</p>
                    <p class="text-xs text-gray-500 mt-1">昨天 16:45</p>
                </div>
                <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200">
                    <p class="text-sm font-medium text-gray-900 truncate">微服务架构设计</p>
                    <p class="text-xs text-gray-500 mt-1">昨天 09:20</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="ml-80 flex flex-col h-screen">
        <!-- 聊天区域顶部 -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">当前会话</h2>
                    <p class="text-sm text-gray-500">
                        <i class="fas fa-database mr-1"></i>
                        <span id="selectedKB">技术规范库</span> · 
                        <i class="fas fa-brain mr-1"></i>
                        <span id="selectedModel">Qwen2-7B</span>
                    </p>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="text-gray-600 hover:text-gray-900 p-2">
                        <i class="fas fa-bookmark"></i>
                    </button>
                    <button class="text-gray-600 hover:text-gray-900 p-2">
                        <i class="fas fa-share"></i>
                    </button>
                    <button class="text-gray-600 hover:text-gray-900 p-2">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 聊天消息区域 -->
        <div id="chatMessages" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 scrollbar-thin">
            <!-- 欢迎消息 -->
            <div class="text-center py-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-robot text-white text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">RAG智能助手</h3>
                <p class="text-gray-600 mb-6">我可以帮您快速查找技术文档，回答技术问题</p>
                
                <!-- 推荐问题 -->
                <div class="max-w-2xl mx-auto">
                    <p class="text-sm text-gray-500 mb-4">推荐问题:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="askSuggestion('如何设计RESTful API？')" 
                            class="p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all duration-200 text-left">
                            <i class="fas fa-code text-blue-600 mr-2"></i>
                            <span class="text-sm">如何设计RESTful API？</span>
                        </button>
                        <button onclick="askSuggestion('数据库连接池最佳实践？')" 
                            class="p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all duration-200 text-left">
                            <i class="fas fa-database text-green-600 mr-2"></i>
                            <span class="text-sm">数据库连接池最佳实践？</span>
                        </button>
                        <button onclick="askSuggestion('Redis缓存如何优化？')" 
                            class="p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all duration-200 text-left">
                            <i class="fas fa-memory text-red-600 mr-2"></i>
                            <span class="text-sm">Redis缓存如何优化？</span>
                        </button>
                        <button onclick="askSuggestion('微服务架构注意事项？')" 
                            class="p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all duration-200 text-left">
                            <i class="fas fa-project-diagram text-purple-600 mr-2"></i>
                            <span class="text-sm">微服务架构注意事项？</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 输入区域 -->
        <div class="bg-white border-t border-gray-200 p-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-end space-x-4">
                    <div class="flex-1">
                        <textarea id="questionInput" 
                            placeholder="请输入您的问题..."
                            rows="1"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                            onkeypress="handleKeyPress(event)"
                            oninput="autoResize(this)"></textarea>
                    </div>
                    <button id="sendButton" onclick="sendMessage()" 
                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg transition-colors duration-200 flex items-center">
                        <i class="fas fa-paper-plane mr-2"></i>
                        <span>发送</span>
                    </button>
                </div>
                
                <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                    <div class="flex items-center space-x-4">
                        <span><i class="fas fa-lightbulb mr-1"></i>Shift+Enter 换行</span>
                        <span><i class="fas fa-paper-plane mr-1"></i>Enter 发送</span>
                    </div>
                    <div id="charCount">0 / 1000</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 自动调整输入框高度
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            
            // 更新字符计数
            const charCount = document.getElementById('charCount');
            const length = textarea.value.length;
            charCount.textContent = `${length} / 1000`;
            charCount.className = length > 1000 ? 'text-red-500' : 'text-gray-500';
        }

        // 处理回车键
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 发送消息
        function sendMessage() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            // 添加用户消息
            addMessage(question, 'user');
            
            // 清空输入
            input.value = '';
            autoResize(input);
            
            // 显示AI思考状态
            showTyping();
            
            // 模拟AI回复（实际项目中这里会调用API）
            setTimeout(() => {
                hideTyping();
                const response = generateResponse(question);
                addMessage(response.content, 'assistant', response.references);
            }, 2000);
        }

        // 添加消息到聊天区域
        function addMessage(content, type, references = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-animation';
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex justify-end mb-4">
                        <div class="max-w-3xl">
                            <div class="bg-blue-600 text-white p-4 rounded-lg rounded-br-none">
                                <p class="whitespace-pre-wrap">${content}</p>
                            </div>
                            <div class="text-right mt-1">
                                <span class="text-xs text-gray-500">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</span>
                            </div>
                        </div>
                        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                    </div>
                `;
            } else {
                let referencesHtml = '';
                if (references && references.length > 0) {
                    referencesHtml = `
                        <div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-quote-left mr-1"></i>参考来源:
                            </h4>
                            <div class="space-y-2">
                                ${references.map(ref => `
                                    <div class="flex items-start space-x-2 text-sm">
                                        <i class="fas fa-file-alt text-blue-600 mt-0.5"></i>
                                        <div>
                                            <span class="font-medium text-gray-900">${ref.document}</span>
                                            <span class="text-gray-500">- 第${ref.page}页</span>
                                            <div class="text-gray-600 mt-1">"${ref.excerpt}"</div>
                                            <div class="text-xs text-gray-500 mt-1">置信度: ${ref.confidence}%</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    <div class="flex justify-start mb-4">
                        <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="max-w-3xl">
                            <div class="bg-white border border-gray-200 p-4 rounded-lg rounded-bl-none shadow-sm">
                                <div class="prose prose-sm max-w-none">
                                    <p class="whitespace-pre-wrap text-gray-900">${content}</p>
                                </div>
                                ${referencesHtml}
                            </div>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs text-gray-500">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</span>
                                <div class="flex items-center space-x-2">
                                    <button class="text-gray-400 hover:text-blue-600 text-xs">
                                        <i class="fas fa-thumbs-up"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-blue-600 text-xs">
                                        <i class="fas fa-thumbs-down"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-blue-600 text-xs">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 显示AI思考状态
        function showTyping() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex justify-start mb-4';
            typingDiv.innerHTML = `
                <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="bg-white border border-gray-200 p-4 rounded-lg rounded-bl-none shadow-sm">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="text-sm text-gray-500 ml-2">AI正在思考...</span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 隐藏AI思考状态
        function hideTyping() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 模拟AI回复生成
        function generateResponse(question) {
            const responses = {
                'API设计': {
                    content: `基于我对技术规范文档的检索，关于RESTful API设计，建议遵循以下最佳实践：

1. **URL设计原则**
   - 使用名词而非动词
   - 资源层级不超过3层
   - 统一使用复数形式

2. **HTTP方法规范**
   - GET: 获取资源
   - POST: 创建资源
   - PUT: 完整更新资源
   - PATCH: 部分更新资源
   - DELETE: 删除资源

3. **状态码使用**
   - 200: 成功
   - 201: 创建成功
   - 400: 请求错误
   - 401: 未认证
   - 403: 无权限
   - 404: 资源不存在
   - 500: 服务器错误

4. **响应格式统一**
   - 统一JSON格式
   - 包含状态码、消息、数据字段
   - 错误信息要具体且有用

这些规范有助于提高API的可维护性和开发效率。`,
                    references: [
                        {
                            document: "API设计规范指南",
                            page: 15,
                            excerpt: "RESTful API应该使用名词来表示资源，动词通过HTTP方法来体现",
                            confidence: 95
                        },
                        {
                            document: "后端开发最佳实践",
                            page: 32,
                            excerpt: "统一的错误处理和响应格式是API设计的重要组成部分",
                            confidence: 88
                        }
                    ]
                },
                default: {
                    content: `根据您的问题，我从知识库中检索到了相关信息。

对于"${question}"这个问题，建议您：

1. 查阅相关技术文档了解基础概念
2. 参考最佳实践和规范标准
3. 结合具体业务场景进行设计
4. 注意性能和安全方面的考虑

如果需要更具体的指导，请提供更多上下文信息，我会给出更针对性的建议。`,
                    references: [
                        {
                            document: "技术开发手册",
                            page: 42,
                            excerpt: "在进行技术选型时，应充分考虑业务需求和系统架构",
                            confidence: 82
                        }
                    ]
                }
            };
            
            // 简单的关键词匹配
            if (question.includes('API') || question.includes('接口')) {
                return responses['API设计'];
            }
            
            return responses.default;
        }

        // 建议问题点击
        function askSuggestion(question) {
            document.getElementById('questionInput').value = question;
            sendMessage();
        }

        // 新建会话
        function newChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="text-center py-8">
                    <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-robot text-white text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">RAG智能助手</h3>
                    <p class="text-gray-600 mb-6">我可以帮您快速查找技术文档，回答技术问题</p>
                </div>
            `;
        }

        // 返回上一页
        function goBack() {
            const userRole = localStorage.getItem('userRole') || 'user';
            if (userRole === 'admin') {
                window.location.href = 'dashboard.html?role=admin';
            } else {
                window.location.href = 'knowledge.html';
            }
        }

        // 监听模型和知识库选择变化
        document.getElementById('knowledgeBase').addEventListener('change', function() {
            const kbNames = {
                'all': '全部知识库',
                'tech': '技术规范库',
                'product': '产品手册',
                'ops': '运维文档'
            };
            document.getElementById('selectedKB').textContent = kbNames[this.value];
        });

        document.getElementById('modelSelect').addEventListener('change', function() {
            document.getElementById('selectedModel').textContent = this.options[this.selectedIndex].text;
        });
    </script>
</body>
</html>
